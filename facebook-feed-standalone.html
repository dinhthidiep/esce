<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng tin - ESMS</title>
    <link rel="stylesheet" href="src/components/FacebookFeed.css">
</head>
<body>
    <div class="main-header">Placeholder Header</div>
    <div class="feed-wrapper">
        <div class="left-sidebar">
            <img src="src/img/avatar-1.png" alt="·∫¢nh ƒë·∫°i di·ªán" class="sidebar-avatar">
            <a href="#profile" class="sidebar-link">üßë Trang c√° nh√¢n</a>
            <a href="#friends" class="sidebar-link">üë• Danh s√°ch b·∫°n b√®</a>
        </div>
        <div class="right-sidebar">
            <h3>üë• B·∫°n b√®</h3>
            <div id="friend-list">
                <div class="friend-item">
                    <img src="src/img/avatar-1.png" alt="avatar" class="friend-avatar">
                    <span class="friend-name">L√™ VƒÉn An</span>
                </div>
                <div class="friend-item">
                    <img src="src/img/avatar-1.png" alt="avatar" class="friend-avatar">
                    <span class="friend-name">Nguy·ªÖn Th·ªã B√¨nh</span>
                </div>
                <div class="friend-item">
                    <img src="src/img/avatar-1.png" alt="avatar" class="friend-avatar">
                    <span class="friend-name">Tr·∫ßn Qu·ªëc C∆∞·ªùng</span>
                </div>
                <div class="friend-item">
                    <img src="src/img/avatar-1.png" alt="avatar" class="friend-avatar">
                    <span class="friend-name">Ph·∫°m Duy</span>
                </div>
                <div class="friend-item">
                    <img src="src/img/avatar-1.png" alt="avatar" class="friend-avatar">
                    <span class="friend-name">H√† Minh Th∆∞</span>
                </div>
            </div>
        </div>
        <div class="main-feed-section">
            <!-- Post Composer -->
            <div class="userpost-card">
                <div class="composer-row">
                    <img src="src/img/avatar-1.png" alt="·∫¢nh ƒë·∫°i di·ªán" class="user-avatar">
                    <textarea id="composer-text" class="composer-input" maxlength="256" placeholder="B·∫°n ƒëang nghƒ© g√¨? (T·ªëi ƒëa 256 k√Ω t·ª±)"></textarea>
                </div>
                <div class="composer-actions">
                    <label for="composer-photo" class="photo-label">üñºÔ∏è ·∫¢nh</label>
                    <input type="file" accept="image/*" id="composer-photo" class="composer-photo-input" multiple>
                    <div id="image-preview-container"></div>
                    <button class="post-btn" id="composer-btn">ƒêƒÉng b√†i</button>
                </div>
            </div>
            <!-- Feed Container -->
            <div id="feed-list"></div>
        </div>
    </div>
    <div class="main-footer">Placeholder Footer</div>
    <script>
// Sample user and post data (stand-in until DB)
const currentUser = {
  avatar: 'src/img/avatar-1.png',
  username: 'B·∫°n'
};
const friends = [
  { name: 'L√™ VƒÉn An', avatar: 'src/img/avatar-1.png' },
  { name: 'Nguy·ªÖn Th·ªã B√¨nh', avatar: 'src/img/avatar-1.png' },
  { name: 'Tr·∫ßn Qu·ªëc C∆∞·ªùng', avatar: 'src/img/avatar-1.png' },
  { name: 'Ph·∫°m Duy', avatar: 'src/img/avatar-1.png' },
  { name: 'H√† Minh Th∆∞', avatar: 'src/img/avatar-1.png' },
  { name: 'V≈© Lan Anh', avatar: 'src/img/avatar-1.png' },
  { name: 'ƒê·ªó Minh ƒê·ª©c', avatar: 'src/img/avatar-1.png' },
  { name: 'B√πi Th·ªã Hoa', avatar: 'src/img/avatar-1.png' },
  { name: 'Ng√¥ VƒÉn T√πng', avatar: 'src/img/avatar-1.png' },
  { name: 'L√Ω Th·ªã Mai', avatar: 'src/img/avatar-1.png' },
  { name: 'Ho√†ng Qu·ªëc Vi·ªát', avatar: 'src/img/avatar-1.png' },
  { name: 'ƒêinh Lan H∆∞∆°ng', avatar: 'src/img/avatar-1.png' }
];
let postIdCounter = 3;
let posts = [
    {
      id: 1,
      username: 'L√™ VƒÉn An',
      avatar: 'src/img/avatar-1.png',
      image: 'src/img/nature-1.jpg',
      text: 'Ch√†o bu·ªïi s√°ng m·ªçi ng∆∞·ªùi! üåº',
      reaction: null, // null, 'like', 'dislike', 'love', 'haha', 'wow'
      comments: ['Ch√†o b·∫°n!', 'Ch√∫c b·∫°n m·ªôt ng√†y t·ªët l√†nh!']
    },
    {
      id: 2,
      username: 'Nguy·ªÖn Th·ªã B√¨nh',
      avatar: 'src/img/avatar-1.png',
      image: 'src/img/nature-1.jpg',
      text: 'Check-in ƒê√† L·∫°t c√πng gia ƒë√¨nh!',
      reaction: null,
      comments: []
    },
    {
      id: 3,
      username: 'Tr·∫ßn Qu·ªëc C∆∞·ªùng',
      avatar: 'src/img/avatar-1.png',
      image: 'src/img/nature-1.jpg',
      text: 'H√¥m nay th·ªùi ti·∫øt ƒë·∫πp qu√°!',
      reaction: null,
      comments: ['ƒê√∫ng v·∫≠y!', 'N√™n ƒëi d·∫°o.']
    },
    {
      id: 4,
      username: 'Ph·∫°m Duy',
      avatar: 'src/img/avatar-1.png',
      image: 'src/img/nature-1.jpg',
      text: 'Ai r·∫£nh ƒëi c√† ph√™ kh√¥ng?',
      reaction: null,
      comments: ['T√¥i r·∫£nh n√®!', 'ƒêi th√¥i!']
    },
    {
      id: 5,
      username: 'H√† Minh Th∆∞',
      avatar: 'src/img/avatar-1.png',
      image: 'src/img/nature-1.jpg',
      text: 'M·ªõi nh·∫≠n vi·ªác m·ªõi, ch√∫c t√¥i may m·∫Øn nh√© m·ªçi ng∆∞·ªùi!',
      reaction: null,
      comments: ['Ch√∫c m·ª´ng b·∫°n!', 'Ch√∫c may m·∫Øn!']
    }
  ];

function renderFeed() {
  const feed = document.getElementById('feed-list');
  feed.innerHTML = '';
  posts.slice().reverse().forEach(post => {
    const card = document.createElement('div');
    card.className = 'post-card';
    card.innerHTML = `
      <div class="post-top">
        <img src="${post.avatar}" alt="avatar" class="post-avatar">
        <span class="post-username">${post.username}</span>
      </div>
      <div class="post-content">${ post.text ? `<div style=\"margin:0.6rem 0 0.3rem 0.1rem;\">${escapeHtml(post.text)}</div>` : '' }</div>
      ${post.images ? `<div class="post-images">${post.images.map((img, idx) => `<img src="${img}" class="post-image" alt="B√†i ƒëƒÉng ${idx + 1}">`).join('')}</div>` : post.image ? `<img src="${post.image}" class="post-image" alt="B√†i ƒëƒÉng">` : ''}
      <div class="post-actions">
        <div class="reaction-container" onmouseenter="showReactionMenu(${post.id})" onmouseleave="hideReactionMenu(${post.id})">
          <button class="action-btn${post.reaction ? ' reacted':''}" onclick="handleReaction(${post.id}, 'like')">
            <span class="reaction-icon">${getReactionIcon(post.reaction)}</span> ${getReactionText(post.reaction)}
          </button>
          <div class="reaction-menu" id="reaction-menu-${post.id}">
            <button class="reaction-option" onclick="handleReaction(${post.id}, 'like')" title="Th√≠ch">üëç</button>
            <button class="reaction-option" onclick="handleReaction(${post.id}, 'dislike')" title="Kh√¥ng th√≠ch">üëé</button>
            <button class="reaction-option" onclick="handleReaction(${post.id}, 'love')" title="Th∆∞∆°ng th∆∞∆°ng">‚ù§Ô∏è</button>
            <button class="reaction-option" onclick="handleReaction(${post.id}, 'haha')" title="Haha">üòÇ</button>
            <button class="reaction-option" onclick="handleReaction(${post.id}, 'wow')" title="Wow">üòÆ</button>
          </div>
        </div>
        <button class="action-btn" onclick="toggleCommentBox(${post.id})">üí¨ B√¨nh lu·∫≠n</button>
        <button class="action-btn" onclick="alert('T√≠nh nƒÉng chia s·∫ª ch∆∞a c√≥!')">‚ÜóÔ∏è Chia s·∫ª</button>
      </div>
      <div class="comment-section" id="comment-section-${post.id}" style="display:none;">
         <div class="comment-list" id="comment-list-${post.id}">
           ${post.comments.map(c => `<div class=\"comment\">${escapeHtml(c)}</div>`).join('')}
         </div>
         <div class="comment-input-wrap">
           <input type="text" class="comment-input" id="comment-input-${post.id}" maxlength="128" placeholder="Vi·∫øt b√¨nh lu·∫≠n...">
           <button class="comment-submit-btn" onclick="addComment(${post.id})">G·ª≠i</button>
         </div>
      </div>
    `;
    feed.appendChild(card);
  });
}

function renderFriends() {
  console.log('Rendering friends list');
  console.log('Friends count:', friends.length);
  const friendList = document.getElementById('friend-list');
  friendList.innerHTML = '';
  friends.forEach(friend => {
    const item = document.createElement('div');
    item.className = 'friend-item';
    item.innerHTML = `
      <img src="${friend.avatar}" alt="avatar" class="friend-avatar">
      <span class="friend-name">${friend.name}</span>
    `;
    friendList.appendChild(item);
  });
}
function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}
function getReactionIcon(reaction) {
  const icons = {
    'like': 'üëç',
    'dislike': 'üëé',
    'love': '‚ù§Ô∏è',
    'haha': 'üòÇ',
    'wow': 'üòÆ'
  };
  return reaction ? icons[reaction] : 'üëç';
}

function getReactionText(reaction) {
  const texts = {
    'like': 'Th√≠ch',
    'dislike': 'Kh√¥ng th√≠ch',
    'love': 'Th∆∞∆°ng th∆∞∆°ng',
    'haha': 'Haha',
    'wow': 'Wow'
  };
  return reaction ? texts[reaction] : 'Th√≠ch';
}

let hoverTimeouts = {};
window.showReactionMenu = function(id) {
  clearTimeout(hoverTimeouts[id]);
  hoverTimeouts[id] = setTimeout(() => {
    const menu = document.getElementById('reaction-menu-' + id);
    if (menu) {
      menu.classList.add('visible');
    }
  }, 500); // 0.5 seconds delay
};

window.hideReactionMenu = function(id) {
  clearTimeout(hoverTimeouts[id]);
  const menu = document.getElementById('reaction-menu-' + id);
  if (menu) {
    menu.classList.remove('visible');
  }
};

window.handleReaction = async function(postId, reactionType) {
  // Update local state
  posts = posts.map(p => p.id === postId ? {...p, reaction: p.reaction === reactionType ? null : reactionType} : p);

  // Update UI immediately
  renderFeed();

  // TODO: Send to backend database
  try {
    const token = localStorage.getItem('jwt'); // Assuming JWT is stored
    const response = await fetch('/api/reactions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        postId: postId,
        reactionType: reactionType,
        userId: 1 // TODO: Get from JWT
      })
    });

    if (!response.ok) {
      console.error('Failed to save reaction to database');
      // Could revert UI here if needed
    }
  } catch (error) {
    console.error('Error saving reaction:', error);
  }
};

window.toggleLike = function(id) {
  posts = posts.map(p => p.id === id ? {...p, liked: !p.liked} : p);
  renderFeed();
  renderFriends();
  console.log('Page loaded, friends should be rendered');
  renderFriends();
};
window.toggleCommentBox = function(id) {
  const box = document.getElementById('comment-section-' + id);
  if (box) { box.style.display = (box.style.display === 'none') ? 'block' : 'none'; }
};
window.addComment = function(id) {
  const input = document.getElementById('comment-input-' + id);
  if (input && input.value.trim()) {
    posts = posts.map(p => p.id === id ? {...p, comments: [...p.comments, input.value.trim()]} : p);
    renderFeed();
    window.toggleCommentBox(id);
    window.toggleCommentBox(id);
  }
};
// Composer: handle new post
const composerBtn = document.getElementById('composer-btn');
const composerText = document.getElementById('composer-text');
const composerPhoto = document.getElementById('composer-photo');
const imagePreviewContainer = document.getElementById('image-preview-container');
let pendingImages = [];

function renderImagePreviews() {
  imagePreviewContainer.innerHTML = '';
  pendingImages.forEach((imageData, index) => {
    const previewItem = document.createElement('div');
    previewItem.className = 'image-preview-item';
    previewItem.innerHTML = `
      <img src="${imageData}" class="image-preview" alt="Preview ${index + 1}">
      <button class="image-remove-btn" onclick="removeImage(${index})" title="X√≥a ·∫£nh">√ó</button>
    `;
    imagePreviewContainer.appendChild(previewItem);
  });
}

window.removeImage = function(index) {
  pendingImages.splice(index, 1);
  renderImagePreviews();
  // Update file input to reflect removed images
  const dt = new DataTransfer();
  const files = Array.from(composerPhoto.files);
  files.splice(index, 1);
  files.forEach(file => dt.items.add(file));
  composerPhoto.files = dt.files;
};

composerPhoto.addEventListener('change', function(e) {
  const files = Array.from(e.target.files);
  pendingImages = [];

  files.forEach(file => {
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        pendingImages.push(ev.target.result);
        renderImagePreviews();
      };
      reader.readAsDataURL(file);
    }
  });
});
composerBtn.onclick = function() {
  const text = composerText.value.trim();
  if (!text && pendingImages.length === 0) {
    alert('Vui l√≤ng nh·∫≠p n·ªôi dung ho·∫∑c ch·ªçn ·∫£nh!');
    return;
  }
  posts.push({
    id: ++postIdCounter,
    username: currentUser.username,
    avatar: currentUser.avatar,
    images: pendingImages.length > 0 ? pendingImages : null,
    image: pendingImages.length > 0 ? pendingImages[0] : null, // Keep backward compatibility
    text,
    reaction: null,
    comments: []
  });
  composerText.value = '';
  pendingImages = [];
  composerPhoto.value = '';
  renderImagePreviews();
  renderFeed();
};
renderFeed();
    </script>
</body>
</html>
